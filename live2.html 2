<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muminji & Evurore Wards ¬∑ Public Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: #f1f5f9;
            padding: 24px 16px;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        /* header card */
        .header-card {
            background: linear-gradient(145deg, #0b2a4a 0%, #133e63 100%);
            color: white;
            border-radius: 32px;
            padding: 30px 32px;
            margin-bottom: 28px;
            box-shadow: 0 18px 30px -12px rgba(10, 40, 70, 0.35);
        }
        .header-top {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .ward-title h1 {
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .ward-title span {
            background: rgba(255,255,255,0.15);
            padding: 4px 14px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 500;
        }
        .ward-selector {
            display: flex;
            gap: 12px;
            background: rgba(0,0,0,0.2);
            padding: 6px;
            border-radius: 50px;
        }
        .ward-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 10px 28px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .ward-btn.active {
            background: white;
            color: #0b2a4a;
        }
        .ward-btn:hover:not(.active) {
            background: rgba(255,255,255,0.15);
        }
        .stats-badge {
            display: flex;
            gap: 28px;
            background: rgba(0,0,0,0.2);
            padding: 12px 28px;
            border-radius: 60px;
            backdrop-filter: blur(4px);
            margin-top: 15px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.75;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value {
            font-size: 1.9rem;
            font-weight: 700;
            line-height: 1.2;
        }
        /* filter bar */
        .filter-bar {
            background: white;
            border-radius: 60px;
            padding: 8px 8px 8px 24px;
            margin-bottom: 32px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px;
            box-shadow: 0 6px 14px rgba(0,20,40,0.06);
        }
        .filter-label {
            color: #1e3a5f;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-select {
            padding: 10px 20px;
            border-radius: 40px;
            border: 1px solid #dde7f0;
            background: #f9fcff;
            font-weight: 500;
            color: #0f3b6a;
            outline: none;
            cursor: pointer;
            min-width: 250px;
        }
        /* live status pill */
        .live-indicator {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f2f6fc;
            padding: 6px 18px 6px 14px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid #c3d9f0;
        }
        .live-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.6);
            animation: pulse 1.8s infinite;
        }
        .live-dot.inactive {
            background: #94a3b8;
            animation: none;
            box-shadow: none;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.6); }
            70% { box-shadow: 0 0 0 8px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .live-text {
            color: #1e3a5f;
        }
        .admin-badge {
            background: #f97316;
            color: white;
            border-radius: 30px;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            margin-bottom: 35px;
        }
        .summary-item {
            background: white;
            border-radius: 24px;
            padding: 22px 22px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.02);
            border: 1px solid #eef3f8;
            transition: all 0.15s;
        }
        .summary-title {
            color: #53718e;
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 10px;
        }
        .summary-number {
            font-size: 2.6rem;
            font-weight: 700;
            color: #0f3b6a;
        }
        .summary-desc {
            color: #2f5670;
            margin-top: 8px;
            border-top: 1px dashed #cbd6e4;
            padding-top: 10px;
            font-size: 0.9rem;
        }
        .discrepancy-badge {
            background: #fee9e7;
            color: #b3402c;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 30px;
            display: inline-block;
            font-size: 0.8rem;
        }
        /* station grid */
        .station-grid {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .station-card {
            background: white;
            border-radius: 28px;
            padding: 0;
            box-shadow: 0 10px 25px -8px rgba(0,0,0,0.06);
            border: 1px solid #e7edf4;
            overflow: hidden;
            transition: all 0.2s;
        }
        .station-header {
            background: #f9fcff;
            padding: 20px 25px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #e2eaf2;
            cursor: pointer;
        }
        .station-name {
            font-size: 1.5rem;
            font-weight: 650;
            color: #0b2d4b;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .voter-count {
            background: #e2ecf9;
            border-radius: 40px;
            padding: 6px 16px;
            font-weight: 600;
            color: #1c4b77;
            font-size: 0.95rem;
        }
        .agent-info {
            display: flex;
            gap: 24px;
            color: #3c5775;
            flex-wrap: wrap;
        }
        .expand-icon {
            font-size: 1.4rem;
            opacity: 0.6;
        }
        .candidate-table {
            padding: 16px 20px 20px 20px;
            background: #ffffff;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        th {
            text-align: left;
            padding: 14px 8px 8px 8px;
            color: #4d6a89;
            font-weight: 600;
            border-bottom: 1px solid #d9e2ec;
        }
        td {
            padding: 12px 8px;
            border-bottom: 1px solid #f0f4fa;
        }
        .candidate-name {
            font-weight: 600;
            color: #1a3857;
        }
        .number-cell {
            font-weight: 600;
            color: #253c5c;
        }
        .diff-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        .diff-match {
            background: #e0f6e5;
            color: #0b6e3f;
        }
        .diff-mismatch {
            background: #ffe3df;
            color: #b13e2e;
        }
        .footer-note {
            text-align: center;
            margin-top: 45px;
            color: #637e9c;
            font-size: 0.9rem;
            border-top: 1px solid #d3e0ee;
            padding-top: 24px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.3rem;
            color: #2f5a88;
        }
        .error-message {
            background: #ffefed;
            border-left: 6px solid #c8422c;
            padding: 20px;
            border-radius: 20px;
        }
        .small-note{
            color:#51718e;
            margin-left: 8px;
            font-weight:normal;
        }
        /* top navigation */
        .top-nav{
            width:100%;
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:20px;
            margin-top:20px;
        }
        .nav-left{
            display:flex;
            gap:14px;
            flex-wrap:wrap;
        }
        .nav-link{
            text-decoration:none;
            color:white;
            background:rgba(255,255,255,0.12);
            padding:8px 18px;
            border-radius:40px;
            font-weight:500;
            font-size:0.9rem;
            transition:0.2s;
        }
        .nav-link:hover{
            background:rgba(255,255,255,0.25);
        }
        .nav-link.active{
            background:white;
            color:#0b2a4a;
            font-weight:600;
        }
    </style>
</head>
<body>
<div class="dashboard" id="dashboard">
    <!-- header -->
    <div class="header-card">
        <div class="header-top">
            <div class="ward-title">
                <h1>
                    üó≥Ô∏è <span id="wardNameDisplay">Muminji Ward</span> 
                    <span>public tally</span>
                </h1>
                <div style="margin-top:6px; display:flex; gap:10px; flex-wrap:wrap;" id="wardInfo">
                    <span id="stationsInfo">üìç 26 polling stations</span>
                    <span id="votersInfo">üìã 9,849 registered voters</span>
                </div>
            </div>
            <div class="ward-selector">
                <button class="ward-btn active" id="wardMuminjiBtn">üó≥Ô∏è Muminji</button>
                <button class="ward-btn" id="wardEvuroreBtn">üó≥Ô∏è Evurore</button>
            </div>
        </div>
        
        <div class="top-nav">
            <div class="nav-left">
                <a href="index.html" class="nav-link active"> üè°  HOME PAGE</a>
            </div>
        </div>
        
        <div class="stats-badge" id="liveStatsHeader">
            <div class="stat-item">
                <span class="stat-label">stations reported</span>
                <span class="stat-value" id="reportedCount">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">with discrepancy</span>
                <span class="stat-value" id="discrepancyCount">0</span>
            </div>
        </div>
    </div>

    <!-- filter / search bar ‚Äì with dynamic LIVE indicator -->
    <div class="filter-bar">
        <span class="filter-label">üîé Filter by status</span>
        <select id="statusFilter" class="filter-select">
            <option value="all">All stations</option>
            <option value="reported">Reported (submitted)</option>
            <option value="pending">Pending (not submitted)</option>
            <option value="discrepancy">With agent/IEBC mismatch</option>
        </select>
        
        <!-- LIVE indicator that reflects admin status -->
        <div class="live-indicator" id="liveIndicator">
            <span class="live-dot" id="liveDot"></span>
            <span class="live-text" id="liveText">LIVE</span>
            <span class="admin-badge" id="adminStatusBadge">results streaming</span>
        </div>
    </div>

    <!-- summary cards dynamic -->
    <div class="summary-cards" id="summaryCards">
        <div class="summary-item">
            <div class="summary-title">total votes cast</div>
            <div class="summary-number" id="totalCasted">‚Äî</div>
            <div class="summary-desc" id="castedDesc">across reported stations</div>
        </div>
        <div class="summary-item">
            <div class="summary-title">rejected ballots</div>
            <div class="summary-number" id="totalRejected">‚Äî</div>
            <div class="summary-desc" id="rejectedDesc">total rejected</div>
        </div>
        <div class="summary-item">
            <div class="summary-title">stations in</div>
            <div class="summary-number" id="submittedCount">0/26</div>
            <div class="summary-desc" id="pendingDesc">click to expand</div>
        </div>
    </div>

    <!-- stations container (dynamic) -->
    <div id="stationsContainer" class="station-grid">
        <div class="loading">üì° Loading polling station data ...</div>
    </div>

    <div class="footer-note">
        ‚öñÔ∏è IEBC comparative dashboard ¬∑ Last updated <span id="timestamp">just now</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyCJEJGa_GBufklAc7gl9-TjjBbpxao7_J8",
        authDomain: "tallying-9df93.firebaseapp.com",
        projectId: "tallying-9df93"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ==================== WARD DATA ====================
    
    // Muminji Ward Stations (26 stations)
    const MUMINJI_STATIONS = [
        { name: "Kivue Primary School", voters: 686 },
        { name: "Mbarwari Primary School", voters: 586 },
        { name: "Cieria Primary School", voters: 492 },
        { name: "Ndutori Primary School", voters: 486 },
        { name: "Michegethiu Primary School", voters: 471 },
        { name: "Gangara Primary School A", voters: 469 },
        { name: "Gangara Primary School B", voters: 469 },
        { name: "Nguthi Primary School", voters: 441 },
        { name: "Kiamungongo Primary School", voters: 435 },
        { name: "Itiira Primary School A", voters: 417 },
        { name: "Itiira Primary School B", voters: 416 },
        { name: "Karimari Primary School", voters: 404 },
        { name: "Ngiir√Æ Primary School A", voters: 402 },
        { name: "Ngiir√Æ Primary School B", voters: 401 },
        { name: "Karambari Primary School", voters: 386 },
        { name: "Kirie Primary School A", voters: 377 },
        { name: "Kirie Primary School B", voters: 377 },
        { name: "Gatakari Primary School", voters: 338 },
        { name: "Rwagori Primary School", voters: 278 },
        { name: "Mukororia Primary School", voters: 272 },
        { name: "Kavui Primary School", voters: 232 },
        { name: "Kandomba Primary School", voters: 229 },
        { name: "Gatothia Primary School", voters: 164 },
        { name: "Kianjogu Primary School", voters: 148 },
        { name: "Kathutheri Primary School", voters: 142 },
        { name: "Mianjatiri Primary School", voters: 131 }
    ];

    // Evurore Ward Stations (67 stations)
    const EVURORE_STATIONS = [
        { name: "KANYUAMBORA PRIMARY SCHOOL (Stream 1)", voters: 589 },
        { name: "KANYUAMBORA PRIMARY SCHOOL (Stream 2)", voters: 588 },
        { name: "KANYUAMBORA PRIMARY SCHOOL (Stream 3)", voters: 588 },
        { name: "KAVENGERO PRIMARY SCHOOL (Stream 1)", voters: 508 },
        { name: "KAVENGERO PRIMARY SCHOOL (Stream 2)", voters: 508 },
        { name: "IRIRI PRIMARY SCHOOL", voters: 454 },
        { name: "GITIE PRIMARY SCHOOL", voters: 636 },
        { name: "CIANTHIA PRIMARY SCHOOL", voters: 459 },
        { name: "NGUNYUMU PRIMARY SCHOOL", voters: 607 },
        { name: "KATHIGAGACERU PRIMARY SCHOOL", voters: 364 },
        { name: "KATHAGUTARI PRIMARY SCHOOL (Stream 1)", voters: 381 },
        { name: "KATHAGUTARI PRIMARY SCHOOL (Stream 2)", voters: 380 },
        { name: "IBUTUKA PRIMARY SCHOOL", voters: 396 },
        { name: "KUI PRIMARY SCHOOL", voters: 366 },
        { name: "KARUARI PRIMARY SCHOOL (Stream 1)", voters: 417 },
        { name: "KARUARI PRIMARY SCHOOL (Stream 2)", voters: 417 },
        { name: "KIGWAMBITI PRIMARY SCHOOL", voters: 547 },
        { name: "KIENIRE PRIMARY SCHOOL", voters: 646 },
        { name: "KAMUKANYA PRIMARY SCHOOL", voters: 370 },
        { name: "NTAMBARI PRIMARY SCHOOL", voters: 439 },
        { name: "NGOCE PRIMARY SCHOOL", voters: 649 },
        { name: "KIRIGO PRIMARY SCHOOL", voters: 423 },
        { name: "NGARWERERI PRIMARY SCHOOL", voters: 323 },
        { name: "MUTIRIAIGURU PRIMARY SCHOOL", voters: 325 },
        { name: "KIANJERU PRIMARY SCHOOL", voters: 464 },
        { name: "KARANGARE PRIMARY SCHOOL", voters: 552 },
        { name: "CIANGERA PRIMARY SCHOOL (Stream 1)", voters: 443 },
        { name: "CIANGERA PRIMARY SCHOOL (Stream 2)", voters: 442 },
        { name: "NJARANGE PRIMARY SCHOOL", voters: 550 },
        { name: "MBARAGA PRIMARY SCHOOL", voters: 417 },
        { name: "MUTHANTHARA PRIMARY SCHOOL", voters: 530 },
        { name: "KOGARI PRIMARY SCHOOL", voters: 523 },
        { name: "KAMUTU PRIMARY SCHOOL", voters: 427 },
        { name: "NTHIGIRANI PRIMARY SCHOOL", voters: 347 },
        { name: "GATATHA PRIMARY SCHOOL", voters: 424 },
        { name: "KIATHAMBU PRIMARY SCHOOL", voters: 392 },
        { name: "KAMWAA PRIMARY SCHOOL", voters: 536 },
        { name: "KIANTHENGE PRIMARY SCHOOL", voters: 462 },
        { name: "GWAKAITHI PRIMARY SCHOOL (Stream 1)", voters: 386 },
        { name: "GWAKAITHI PRIMARY SCHOOL (Stream 2)", voters: 385 },
        { name: "RWANJERU PRIMARY SCHOOL", voters: 239 },
        { name: "GATORORORI PRIMARY SCHOOL", voters: 343 },
        { name: "OVARIRE PRIMARY SCHOOL", voters: 276 },
        { name: "MANGOTE PRIMARY SCHOOL", voters: 260 },
        { name: "ST. PETERS PRIMARY SCHOOL (Stream 1)", voters: 653 },
        { name: "ST. PETERS PRIMARY SCHOOL (Stream 2)", voters: 652 },
        { name: "ST. PETERS PRIMARY SCHOOL (Stream 3)", voters: 652 },
        { name: "KANYUERI PRIMARY SCHOOL", voters: 315 },
        { name: "ST. MARYS KANGANGA PRIMARY SCHOOL", voters: 408 },
        { name: "ITURURI PRIMARY SCHOOL", voters: 370 },
        { name: "USAMBARA PRIMARY SCHOOL", voters: 310 },
        { name: "MUGWANJOGU PRIMARY SCHOOL", voters: 252 },
        { name: "MBACI PRIMARY SCHOOL", voters: 259 },
        { name: "KAMARINDO PRIMARY SCHOOL", voters: 284 },
        { name: "KARIGIRI PRIMARY SCHOOL (Stream 1)", voters: 425 },
        { name: "KARIGIRI PRIMARY SCHOOL (Stream 2)", voters: 425 },
        { name: "ST. KIZITO KATHANGARI PR SCHOOL", voters: 628 },
        { name: "MURANGU PRIMARY SCHOOL", voters: 125 },
        { name: "CIAIKUNGUGU PRIMARY SCHOOL", voters: 127 },
        { name: "KAMBUNGU PRIMARY SCHOOL", voters: 218 },
        { name: "KAMIGUA PRIMARY SCHOOL", voters: 251 },
        { name: "ST. MICHAEL GACURIRI PR SCHOOL", voters: 171 },
        { name: "KANYANGI PRIMARY SCHOOL", voters: 23 },
        { name: "KAMAUA PRIMARY SCHOOL", voters: 27 },
        { name: "KATHERU PRIMARY SCHOOL", voters: 13 },
        { name: "KIANJOYA PRIMARY SCHOOL", voters: 11 },
        { name: "KAMARANDI SECONDARY SCHOOL", voters: 16 }
    ];

    // Calculate Evurore total voters
    const EVURORE_TOTAL_VOTERS = EVURORE_STATIONS.reduce((sum, s) => sum + s.voters, 0);

    // DOM Elements
    const stationsContainer = document.getElementById('stationsContainer');
    const statusFilter = document.getElementById('statusFilter');
    const reportedSpan = document.getElementById('reportedCount');
    const discrepancySpan = document.getElementById('discrepancyCount');
    const totalCastedSpan = document.getElementById('totalCasted');
    const totalRejectedSpan = document.getElementById('totalRejected');
    const submittedCountSpan = document.getElementById('submittedCount');
    const castedDesc = document.getElementById('castedDesc');
    const rejectedDesc = document.getElementById('rejectedDesc');
    
    // Ward display elements
    const wardNameDisplay = document.getElementById('wardNameDisplay');
    const stationsInfo = document.getElementById('stationsInfo');
    const votersInfo = document.getElementById('votersInfo');
    
    // Ward buttons
    const wardMuminjiBtn = document.getElementById('wardMuminjiBtn');
    const wardEvuroreBtn = document.getElementById('wardEvuroreBtn');
    
    // Live indicator elements
    const liveDot = document.getElementById('liveDot');
    const liveText = document.getElementById('liveText');
    const adminStatusBadge = document.getElementById('adminStatusBadge');

    // State
    let currentWard = 'muminji';
    let firebaseDocs = [];
    let allStationsView = [];
    let adminStreamingActive = true;

    // Helper: generate station ID with ward prefix
    function generateStationId(name, ward) {
        return ward + "_" + name.replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, '');
    }

    // Get current stations based on ward
    function getCurrentStations() {
        return currentWard === 'muminji' ? MUMINJI_STATIONS : EVURORE_STATIONS;
    }

    // Get total registered voters for current ward
    function getTotalRegistered() {
        return currentWard === 'muminji' ? 9849 : EVURORE_TOTAL_VOTERS;
    }

    // Update header based on ward
    function updateWardHeader() {
        const stations = getCurrentStations();
        const totalReg = getTotalRegistered();
        
        wardNameDisplay.textContent = currentWard === 'muminji' ? 'Muminji Ward' : 'Evurore Ward';
        stationsInfo.textContent = `üìç ${stations.length} polling stations`;
        votersInfo.textContent = `üìã ${totalReg.toLocaleString()} registered voters`;
        
        // Update button active states
        if (currentWard === 'muminji') {
            wardMuminjiBtn.classList.add('active');
            wardEvuroreBtn.classList.remove('active');
        } else {
            wardEvuroreBtn.classList.add('active');
            wardMuminjiBtn.classList.remove('active');
        }
        
        // Re-merge and render with new ward data
        mergeAndRender();
    }

    // Update LIVE indicator
    function updateLiveIndicator() {
        if (adminStreamingActive) {
            liveDot.className = 'live-dot';
            liveText.innerText = 'LIVE';
            adminStatusBadge.innerText = 'results streaming';
            adminStatusBadge.style.background = '#f97316';
        } else {
            liveDot.className = 'live-dot inactive';
            liveText.innerText = 'STANDBY';
            adminStatusBadge.innerText = 'admin paused';
            adminStatusBadge.style.background = '#64748b';
        }
    }

    // Simulate admin changing status every 12 seconds
    setInterval(() => {
        adminStreamingActive = !adminStreamingActive;
        updateLiveIndicator();
        console.log('Admin streaming active:', adminStreamingActive);
    }, 12000);

    // Fetch all pollingStations from Firebase
    async function loadAllData() {
        try {
            const querySnapshot = await getDocs(collection(db, "pollingStations"));
            firebaseDocs = [];
            querySnapshot.forEach((doc) => {
                firebaseDocs.push({ id: doc.id, ...doc.data() });
            });
            console.log('Fetched docs:', firebaseDocs.length);
            mergeAndRender();
        } catch (e) {
            stationsContainer.innerHTML = `<div class="error-message">‚ùå Error loading data: ${e.message}</div>`;
            firebaseDocs = [];
            mergeAndRender();
        }
    }

    // Merge master stations with firebaseDocs for current ward
    function mergeAndRender() {
        const currentStations = getCurrentStations();
        
        const enriched = currentStations.map(master => {
            const stationId = generateStationId(master.name, currentWard);
            // Find matching Firebase doc for this ward
            const fb = firebaseDocs.find(d => {
                // Match by ID or by station name and ward
                return d.id === stationId || 
                       (d.stationName === master.name && d.ward && d.ward.toLowerCase() === currentWard);
            });
            
            return {
                ...master,
                firebase: fb || null,
                reported: !!fb,
                stationId: stationId
            };
        });

        allStationsView = enriched;
        applyFilterAndRender();
    }

    function applyFilterAndRender() {
        const filter = statusFilter.value;
        const currentStations = getCurrentStations();

        let filtered = [...allStationsView];
        if (filter === 'reported') {
            filtered = filtered.filter(s => s.reported === true);
        } else if (filter === 'pending') {
            filtered = filtered.filter(s => s.reported === false);
        } else if (filter === 'discrepancy') {
            filtered = filtered.filter(s => s.reported && s.firebase?.discrepancyDetected === true);
        }

        // Update header stats (based on all data, not filtered)
        const reportedTotal = allStationsView.filter(s => s.reported).length;
        const discrepancyTotal = allStationsView.filter(s => s.firebase?.discrepancyDetected === true).length;
        reportedSpan.innerText = reportedTotal;
        discrepancySpan.innerText = discrepancyTotal;
        submittedCountSpan.innerText = `${reportedTotal}/${currentStations.length}`;

        // Compute summary numbers from reported stations only
        let totalCasted = 0, totalRejected = 0;
        allStationsView.forEach(s => {
            if (s.firebase) {
                totalCasted += (s.firebase.castedVotes || 0);
                totalRejected += (s.firebase.rejectedVotes || 0);
            }
        });
        totalCastedSpan.innerText = totalCasted.toLocaleString();
        totalRejectedSpan.innerText = totalRejected.toLocaleString();
        castedDesc.innerText = `from ${reportedTotal} polling stations`;
        rejectedDesc.innerText = `total rejected ballots`;

        // Render filtered stations
        if (filtered.length === 0) {
            stationsContainer.innerHTML = `<div class="summary-item" style="grid-column:1/-1; text-align:center; padding:40px;">üì≠ No stations match the selected filter.</div>`;
            return;
        }

        let html = '';
        filtered.forEach((station, idx) => {
            const fb = station.firebase;
            const reported = station.reported;
            const voters = station.voters;

            // Agent info
            const agentName = fb?.agentName ? fb.agentName : '‚Äî';
            const agentPhone = fb?.agentPhone ? fb.agentPhone : '‚Äî';
            const casted = fb?.castedVotes ?? '‚Äî';
            const rejected = fb?.rejectedVotes ?? '‚Äî';
            const discrepancy = fb?.discrepancyDetected ? true : false;

            // Candidate votes (if any)
            let rows = '';
            if (reported && fb?.agentVotes && fb?.iebcVotes) {
                // Get all unique candidate names from both agent and IEBC votes
                const allCandidatesSet = new Set([
                    ...Object.keys(fb.agentVotes || {}),
                    ...Object.keys(fb.iebcVotes || {})
                ]);
                const candidateNames = Array.from(allCandidatesSet);
                
                if (candidateNames.length === 0) {
                    rows = `<tr><td colspan="4" style="padding:18px; color:#777;">No candidate votes recorded</td></tr>`;
                } else {
                    candidateNames.forEach(cname => {
                        const a = fb.agentVotes?.[cname] ?? 0;
                        const i = fb.iebcVotes?.[cname] ?? 0;
                        const diff = a - i;
                        const diffClass = diff === 0 ? 'diff-match' : 'diff-mismatch';
                        rows += `<tr>
                            <td class="candidate-name">${cname}</td>
                            <td class="number-cell">${a}</td>
                            <td class="number-cell">${i}</td>
                            <td><span class="diff-badge ${diffClass}">${diff > 0 ? '+' : ''}${diff}</span></td>
                        </tr>`;
                    });
                }
            } else {
                rows = `<tr><td colspan="4" style="padding:20px; color:#8f9fb2; background:#fafdff; border-radius:12px;">‚è≥ Pending ¬∑ no results submitted yet</td></tr>`;
            }

            // Expand/collapse ID
            const expandId = `expand-${currentWard}-${idx}`;

            html += `
            <div class="station-card" data-reported="${reported}" data-discrepancy="${discrepancy}">
                <div class="station-header" onclick="document.getElementById('${expandId}').classList.toggle('collapsed')">
                    <div class="station-name">
                        üè´ ${station.name}
                        <span class="voter-count">${voters} voters</span>
                        ${!reported ? '<span style="background:#ffecba; color:#8a6200; padding:4px 12px; border-radius:40px; font-size:0.8rem;">‚è≥ pending</span>' : ''}
                        ${discrepancy ? '<span class="discrepancy-badge">‚ö†Ô∏è mismatch</span>' : ''}
                    </div>
                    <div class="agent-info">
                        <span>üìû ${agentPhone}</span>
                        <span>üßë ${agentName}</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                </div>
                <div id="${expandId}" class="candidate-table">
                    <div style="display:flex; gap: 20px; margin-bottom:6px; flex-wrap:wrap; background:#f6faff; padding:10px 14px; border-radius:18px;">
                        <span><strong>üó≥Ô∏è casted:</strong> ${casted}</span>
                        <span><strong>‚ùå rejected:</strong> ${rejected}</span>
                        <span><strong>üìä turnout:</strong> ${reported && voters ? ((casted/voters)*100).toFixed(1)+'%' : '‚Äî'}</span>
                    </div>
                    <table>
                        <thead><tr><th>Candidate</th><th>Agent</th><th>IEBC</th><th>Diff</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            </div>
            `;
        });

        stationsContainer.innerHTML = html;

        // Add collapsed style if not already present
        if (!document.getElementById('toggle-style')) {
            const style = document.createElement('style');
            style.id = 'toggle-style';
            style.innerHTML = `
                .candidate-table.collapsed { display: none; }
                .station-header .expand-icon { transition: transform 0.2s; }
            `;
            document.head.appendChild(style);
        }
    }

    // Event listeners
    statusFilter.addEventListener('change', applyFilterAndRender);
    
    wardMuminjiBtn.addEventListener('click', () => {
        if (currentWard === 'muminji') return;
        currentWard = 'muminji';
        updateWardHeader();
    });
    
    wardEvuroreBtn.addEventListener('click', () => {
        if (currentWard === 'evurore') return;
        currentWard = 'evurore';
        updateWardHeader();
    });

    // Initial load
    updateLiveIndicator();
    updateWardHeader();
    loadAllData();
    
    // Update timestamp
    document.getElementById('timestamp').innerText = new Date().toLocaleTimeString();
</script>
</body>
</html>
