<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>Muminji & Evurore Wards ‚Äì Live Election Results with Candidate Photos</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    background: #f0f4f8;
    padding: 0;
    margin: 0;
    color: #1e293b;
}

/* Header */
.header {
    background: linear-gradient(135deg, #0a2a44, #1a4f89);
    color: white;
    padding: 20px 15px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.header h1 {
    font-size: 1.8rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
}

.header p {
    font-size: 0.95rem;
    opacity: 0.9;
}

/* Navigation */
.main-nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 15px 0 8px;
    flex-wrap: wrap;
}

.nav-btn {
    background: rgba(255,255,255,0.15);
    color: white;
    border: 2px solid rgba(255,255,255,0.3);
    padding: 8px 16px;
    border-radius: 40px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    text-decoration: none;
}

.nav-btn:hover {
    background: rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.5);
    transform: translateY(-2px);
}

.nav-btn.active {
    background: white;
    color: #0a2a44;
    border-color: white;
}

.nav-btn.admin-btn {
    background: #f97316;
    border-color: #f97316;
}

.live-badge {
    background: #dc2626;
    color: white;
    padding: 4px 12px;
    border-radius: 30px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: 10px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

.live-dot {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    display: inline-block;
    animation: blink 1s infinite;
}

@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}

/* Main container */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 10px;
}

/* Last updated */
.last-updated {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 12px 15px;
    border-radius: 50px;
    margin: 15px 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    flex-wrap: wrap;
    gap: 10px;
}

.timestamp {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #64748b;
    font-size: 0.9rem;
}

.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.refresh-btn, .screenshot-btn {
    background: #e6f0ff;
    border: none;
    padding: 6px 14px;
    border-radius: 30px;
    color: #0f3b6a;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.screenshot-btn {
    background: #0f3b6a;
    color: white;
}

.refresh-btn:hover, .screenshot-btn:hover {
    transform: scale(1.02);
}

.refresh-btn:active, .screenshot-btn:active {
    transform: scale(0.98);
}

/* Ward Tabs */
.ward-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.ward-tab {
    padding: 12px 20px;
    border: none;
    background: white;
    border-radius: 40px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    transition: all 0.2s;
    border: 2px solid transparent;
    flex: 1;
    min-width: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.ward-tab.active {
    background: #0f3b6a;
    color: white;
    border-color: #0f3b6a;
}

.ward-tab .count {
    background: rgba(255,255,255,0.2);
    padding: 3px 10px;
    border-radius: 30px;
    font-size: 0.8rem;
}

/* Stats Cards - Mobile Optimized */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
}

.stat-label {
    color: #64748b;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.stat-value {
    font-size: 1.6rem;
    font-weight: 700;
    color: #0f3b6a;
    line-height: 1.2;
}

.stat-sub {
    color: #64748b;
    font-size: 0.75rem;
    margin-top: 3px;
}

/* Progress bar */
.progress-container {
    background: white;
    padding: 15px;
    border-radius: 16px;
    margin-bottom: 20px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 0.9rem;
}

.progress-bar {
    height: 16px;
    background: #e2e8f0;
    border-radius: 30px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #0f3b6a, #2c7be5);
    border-radius: 30px;
    transition: width 0.5s ease;
    color: white;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 8px;
}

/* Enhanced Candidate cards - Mobile First */
.candidates-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.candidate-card {
    background: white;
    border-radius: 20px;
    padding: 0;
    border: 1px solid #e9eef3;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    position: relative;
}

/* Winner highlight */
.candidate-card.winner {
    border: 3px solid #fbbf24;
    box-shadow: 0 8px 25px rgba(251,191,36,0.2);
}

.winner-crown {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #fbbf24;
    color: #92400e;
    padding: 6px 12px;
    border-radius: 30px;
    font-size: 0.8rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 5px;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.candidate-photo-header {
    height: 80px;
    background: linear-gradient(135deg, #0f3b6a, #2c7be5);
    position: relative;
    display: flex;
    justify-content: center;
}

.candidate-profile-img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid white;
    background: #e6f0ff;
    position: absolute;
    bottom: -30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: 700;
    color: #0f3b6a;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    object-fit: cover;
}

.candidate-info {
    margin-top: 40px;
    padding: 12px 12px 8px;
    text-align: center;
    border-bottom: 1px solid #edf2f9;
}

.candidate-info h3 {
    font-size: 1.1rem;
    margin-bottom: 5px;
    color: #0b2d4b;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
}

.ranking-badge {
    display: inline-block;
    background: #0f3b6a;
    color: white;
    padding: 3px 10px;
    border-radius: 30px;
    font-size: 0.7rem;
    font-weight: 600;
}

.candidate-party-badge {
    display: inline-block;
    background: #e6f0ff;
    padding: 4px 12px;
    border-radius: 30px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #0f3b6a;
    margin-top: 3px;
}

/* Vote comparison - Simplified for mobile */
.vote-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 5px;
    padding: 12px;
    background: #f8fafd;
}

.vote-box {
    text-align: center;
    padding: 8px 4px;
    border-radius: 12px;
}

.vote-box.agent {
    background: #e6f0ff;
    border-bottom: 3px solid #0f3b6a;
}

.vote-box.iebc {
    background: #e8f7ef;
    border-bottom: 3px solid #166534;
}

.vote-box.diff {
    background: #fef3c7;
    border-bottom: 3px solid #92400e;
}

.vote-label {
    font-size: 0.6rem;
    color: #64748b;
    margin-bottom: 4px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.vote-number {
    font-size: 1.1rem;
    font-weight: 800;
    line-height: 1.2;
}

.diff-number {
    font-size: 1.1rem;
    font-weight: 800;
}

.diff-number.positive { color: #166534; }
.diff-number.negative { color: #991b1b; }
.diff-number.zero { color: #64748b; }

.vote-percentage {
    font-size: 0.6rem;
    color: #64748b;
    margin-top: 3px;
    font-weight: 600;
}

/* Stats footer */
.candidate-stats-footer {
    display: flex;
    justify-content: space-between;
    padding: 10px 12px;
    background: white;
    border-top: 1px solid #edf2f9;
    font-size: 0.75rem;
    color: #4a627a;
}

.candidate-stat-item {
    display: flex;
    align-items: center;
    gap: 3px;
}

.candidate-stat-value {
    font-weight: 700;
    color: #0f3b6a;
}

/* Stations table - Horizontal scroll */
.results-section {
    background: white;
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
}

.section-title {
    font-size: 1.2rem;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #0f3b6a;
    flex-wrap: wrap;
}

.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin: 0 -5px;
    padding: 0 5px;
}

.stations-table {
    width: 100%;
    min-width: 800px;
    border-collapse: collapse;
    font-size: 0.8rem;
}

.stations-table th {
    text-align: left;
    padding: 10px 8px;
    background: #f8fafd;
    color: #364d6b;
    font-weight: 600;
    font-size: 0.8rem;
}

.stations-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #edf2f9;
}

.station-status {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 30px;
    font-size: 0.7rem;
    font-weight: 600;
}

.status-submitted {
    background: #dcfce7;
    color: #166534;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.discrepancy-badge {
    background: #fee2e2;
    color: #991b1b;
    padding: 3px 6px;
    border-radius: 30px;
    font-size: 0.65rem;
    font-weight: 600;
    display: inline-block;
}

/* Loading */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px;
    flex-direction: column;
    gap: 10px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e6f0ff;
    border-top-color: #0f3b6a;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Footer */
.footer {
    text-align: center;
    padding: 20px;
    color: #64748b;
    border-top: 1px solid #e2e8f0;
    margin-top: 20px;
    font-size: 0.8rem;
}

/* Screenshot notification */
.screenshot-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    left: 20px;
    background: #0f3b6a;
    color: white;
    padding: 15px;
    border-radius: 50px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    z-index: 9999;
    animation: slideDown 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-align: center;
}

@keyframes slideDown {
    from {
        transform: translateY(-100%);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Screenshot mode - hides navigation for cleaner capture */
body.screenshot-mode .main-nav,
body.screenshot-mode .action-buttons,
body.screenshot-mode .live-badge,
body.screenshot-mode .footer {
    display: none !important;
}

body.screenshot-mode .header {
    padding: 15px;
}

body.screenshot-mode .header h1 {
    font-size: 1.5rem;
}

/* Tablet and up */
@media (min-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .candidates-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .header h1 {
        font-size: 2.2rem;
    }
    
    .stat-value {
        font-size: 2rem;
    }
}

@media (min-width: 1024px) {
    .candidates-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}
</style>
<!-- html2canvas for screenshots -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<div class="header">
    <h1>
        <span>üó≥Ô∏è</span>
        Muminji & Evurore Wards
        <span>üó≥Ô∏è</span>
    </h1>
    <p>Live Election Results Portal ‚Ä¢ Official Tallying Centre</p>
    
    <!-- Navigation -->
    <div class="main-nav">
        <a href="live2.html"nav-btn active">
            <span>üìä</span> Results per pollingStations
        </a>
        <a href="live.html"nav-btn admin-btn">
            <span>üîê</span> tabulated data
        </a>
    </div>
    
    <div class="live-badge">
        <span class="live-dot"></span>
        LIVE - Auto refreshes
    </div>
</div>

<div class="container">
    <!-- Last Updated with Screenshot Button -->
    <div class="last-updated">
        <div class="timestamp">
            <span>üïí</span>
            <span id="lastUpdated">Loading...</span>
        </div>
        <div class="action-buttons">
            <button class="refresh-btn" id="manualRefreshBtn">
                <span>üîÑ</span>
                Refresh
            </button>
            <button class="screenshot-btn" id="screenshotBtn">
                <span>üì∏</span>
                Share
            </button>
        </div>
    </div>

    <!-- Ward Tabs -->
    <div class="ward-tabs">
        <button class="ward-tab active" id="tabMuminji">
            <span>üó≥Ô∏è</span>
            Muminji (7)
            <span class="count" id="muminjiCount">0/26</span>
        </button>
        <button class="ward-tab" id="tabEvurore">
            <span>üó≥Ô∏è</span>
            Evurore (10)
            <span class="count" id="evuroreCount">0/67</span>
        </button>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label"><span>üìä</span> Registered</div>
            <div class="stat-value" id="totalRegistered">0</div>
            <div class="stat-sub">voters</div>
        </div>
        <div class="stat-card">
            <div class="stat-label"><span>‚úÖ</span> Votes Cast</div>
            <div class="stat-value" id="totalVotesCast">0</div>
            <div class="stat-sub" id="voterTurnout">0% turnout</div>
        </div>
        <div class="stat-card">
            <div class="stat-label"><span>üìã</span> Reported</div>
            <div class="stat-value" id="stationsReported">0</div>
            <div class="stat-sub" id="stationsTotal">/0 stations</div>
        </div>
        <div class="stat-card">
            <div class="stat-label"><span>‚ö†Ô∏è</span> Discrepancies</div>
            <div class="stat-value" id="discrepanciesCount">0</div>
            <div class="stat-sub">mismatches</div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-header">
            <span>Reporting Progress</span>
            <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading">
        <div class="loading-spinner"></div>
        <p>Fetching latest results...</p>
    </div>

    <!-- Results Content -->
    <div id="resultsContent" style="display: none;">
        <!-- Candidates Section with Profile Photos -->
        <div class="results-section">
            <h2 class="section-title">
                <span>üèÜ</span>
                Candidate Rankings - <span id="wardNameDisplay">Muminji Ward</span>
            </h2>
            <div id="candidatesGrid" class="candidates-grid"></div>
        </div>

        <!-- Polling Stations -->
        <div class="results-section">
            <h2 class="section-title">
                <span>üìç</span>
                Polling Stations - <span id="stationWardName">Muminji Ward</span>
            </h2>
            <div class="table-wrapper">
                <table class="stations-table" id="stationsTable">
                    <thead>
                        <tr>
                            <th>Station Name</th>
                            <th>Serial No.</th>
                            <th>Registered</th>
                            <th>Casted</th>
                            <th>Rejected</th>
                            <th>Status</th>
                            <th>Discrepancy</th>
                        </tr>
                    </thead>
                    <tbody id="stationsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    <p>¬© IEBC - Official Results Portal</p>
    <p>Last sync: <span id="footerTimestamp">-</span></p>
</div>

<!-- Screenshot notification -->
<div id="screenshotNotification" class="screenshot-notification" style="display: none;">
    <span>‚úÖ</span>
    <span id="notificationMessage">Screenshot saved!</span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCJEJGa_GBufklAc7gl9-TjjBbpxao7_J8",
    authDomain: "tallying-9df93.firebaseapp.com",
    projectId: "tallying-9df93"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// DOM Elements
const loadingIndicator = document.getElementById('loadingIndicator');
const resultsContent = document.getElementById('resultsContent');
const lastUpdatedSpan = document.getElementById('lastUpdated');
const footerTimestamp = document.getElementById('footerTimestamp');
const manualRefreshBtn = document.getElementById('manualRefreshBtn');
const screenshotBtn = document.getElementById('screenshotBtn');
const screenshotNotification = document.getElementById('screenshotNotification');
const notificationMessage = document.getElementById('notificationMessage');

const tabMuminji = document.getElementById('tabMuminji');
const tabEvurore = document.getElementById('tabEvurore');
const wardNameDisplay = document.getElementById('wardNameDisplay');
const stationWardName = document.getElementById('stationWardName');

const totalRegistered = document.getElementById('totalRegistered');
const totalVotesCast = document.getElementById('totalVotesCast');
const voterTurnout = document.getElementById('voterTurnout');
const stationsReported = document.getElementById('stationsReported');
const stationsTotal = document.getElementById('stationsTotal');
const discrepanciesCount = document.getElementById('discrepanciesCount');
const progressPercent = document.getElementById('progressPercent');
const progressFill = document.getElementById('progressFill');

const muminjiCount = document.getElementById('muminjiCount');
const evuroreCount = document.getElementById('evuroreCount');
const candidatesGrid = document.getElementById('candidatesGrid');
const stationsBody = document.getElementById('stationsBody');

// Constants
const MUMINJI_STATIONS = 26;
const EVURORE_STATIONS = 67;
const MUMINJI_VOTERS = 9849;
const EVURORE_VOTERS = 25647;

// ========== MUMINJI CANDIDATES with PROPER PHOTO PATHS ==========
const MUMINJI_CANDIDATES = [
    { 
        id: "c1", 
        name: "Ngari Boniface Kariuki", 
        party: "", 
        partyCode: "",
        partyColor: "#0f3b6a",
        photo: "boni.png",
        initials: "NB"
    },
    { 
        id: "c2", 
        name: "Ngari John Nyaga", 
        party: "", 
        partyCode: "",
        partyColor: "#0f3b6a",
        photo: "John.png",
        initials: "NJ"
    },
    { 
        id: "c3", 
        name: "Njeru Cosmas", 
        party: "", 
        partyCode: "",
        partyColor: "#0f3b6a",
        photo: "cos.png",
        initials: "NC"
    },
    { 
        id: "c4", 
        name: "Njiru Joseph Ngari", 
        party: "", 
        partyCode: "",
        partyColor: "#0f3b6a",
        photo: "Joseph.png",
        initials: "JJ"
    },
    { 
        id: "c5", 
        name: "Njiru Peterson Njeru", 
        party: "", 
        partyCode: "",
        partyColor: "#0f3b6a",
        photo: "Peter.png",
        initials: "PN"
    },
    { 
        id: "c6", 
        name: "Njuki Charles Kiura", 
        party: "", 
        partyCode: "",
        partyColor: "#0f3b6a",
        photo: "chali.png",
        initials: "CK"
    },
    { 
        id: "c7", 
        name: "Nthinga Zachary Mbogo", 
        party: "", 
        partyCode: "",
        partyColor: "#0f3b6a",
        photo: "zac.png",
        initials: "ZM"
    }
];

// ========== EVURORE CANDIDATES - ALL 10 with PROPER PHOTO PATHS ==========
const EVURORE_CANDIDATES = [
    { 
        id: "e1", 
        name: "Eston Fundi Njiru", 
        party: "Umoja Na Maendeleo Party", 
        partyCode: "UMP",
        partyColor: "#f59e0b",
        photo: "eston.png",
        initials: "EF"
    },
    { 
        id: "e2", 
        name: "Johnson Mukui Mate", 
        party: "Independent", 
        partyCode: "IND",
        partyColor: "#6b7280",
        photo: "johnson.png",
        initials: "JM"
    },
    { 
        id: "e3", 
        name: "Virginia Thaara Njiru", 
        party: "Kenya Moja Movement", 
        partyCode: "KMM",
        partyColor: "#10b981",
        photo: "virginia.png",
        initials: "VN"
    },
    { 
        id: "e4", 
        name: "Joseph Nyaga Njeru", 
        party: "People's Liberation Party", 
        partyCode: "PLP",
        partyColor: "#b45309",
        photo: "joseph_nyaga.png",
        initials: "JN"
    },
    { 
        id: "e5", 
        name: "Kennedy Nthiga Njeru", 
        party: "United Green Movement", 
        partyCode: "UGM",
        partyColor: "#16a34a",
        photo: "kennedy.png",
        initials: "KN"
    },
    { 
        id: "e6", 
        name: "Martin Mukundi Muriithi", 
        party: "National Economic Development Party", 
        partyCode: "NEDP",
        partyColor: "#2563eb",
        photo: "martin.png",
        initials: "MM"
    },
    { 
        id: "e7", 
        name: "Kenneth Njeru Nyaga", 
        party: "Chama Cha Kazi", 
        partyCode: "CCK",
        partyColor: "#9333ea",
        photo: "kenneth.png",
        initials: "KN"
    },
    { 
        id: "e8", 
        name: "Albert Muchira Kigoro", 
        party: "Democratic Party of Kenya", 
        partyCode: "DPK",
        partyColor: "#0891b2",
        photo: "albert.png",
        initials: "AK"
    },
    { 
        id: "e9", 
        name: "Duncan Muratia Nyaga", 
        party: "United Democratic Alliance", 
        partyCode: "UDA",
        partyColor: "#dc2626",
        photo: "duncan.png",
        initials: "DN"
    },
    { 
        id: "e10", 
        name: "Catherine Mururi Kabuthi", 
        party: "United Progressive Alliance", 
        partyCode: "UPA",
        partyColor: "#7e22ce",
        photo: "catherine.png",
        initials: "CK"
    }
];

// State
let currentWard = 'muminji';
let allStations = [];
let refreshInterval;

// Initialize
async function initialize() {
    setupRealtimeListeners();
    
    refreshInterval = setInterval(() => {
        updateTimestamp();
    }, 30000);
    
    // Tab click handlers
    tabMuminji.addEventListener('click', () => {
        if (currentWard === 'muminji') return;
        currentWard = 'muminji';
        updateTabStyles();
        renderCurrentWard();
    });
    
    tabEvurore.addEventListener('click', () => {
        if (currentWard === 'evurore') return;
        currentWard = 'evurore';
        updateTabStyles();
        renderCurrentWard();
    });
    
    manualRefreshBtn.addEventListener('click', () => {
        updateTimestamp();
        manualRefreshBtn.style.transform = 'rotate(180deg)';
        setTimeout(() => {
            manualRefreshBtn.style.transform = 'rotate(0deg)';
        }, 300);
    });
    
    screenshotBtn.addEventListener('click', takeScreenshot);
}

function updateTabStyles() {
    if (currentWard === 'muminji') {
        tabMuminji.classList.add('active');
        tabEvurore.classList.remove('active');
        wardNameDisplay.textContent = 'Muminji Ward';
        stationWardName.textContent = 'Muminji Ward';
    } else {
        tabEvurore.classList.add('active');
        tabMuminji.classList.remove('active');
        wardNameDisplay.textContent = 'Evurore Ward';
        stationWardName.textContent = 'Evurore Ward';
    }
}

function setupRealtimeListeners() {
    const stationsRef = collection(db, "pollingStations");
    
    onSnapshot(stationsRef, (snapshot) => {
        allStations = [];
        snapshot.forEach(doc => {
            allStations.push({ id: doc.id, ...doc.data() });
        });
        
        updateStationCounts();
        renderCurrentWard();
        
        loadingIndicator.style.display = 'none';
        resultsContent.style.display = 'block';
        updateTimestamp();
    }, (error) => {
        console.error('Error:', error);
    });
}

function updateStationCounts() {
    const muminjiSubmitted = allStations.filter(s => s.ward === 'Muminji').length;
    const evuroreSubmitted = allStations.filter(s => s.ward === 'Evurore').length;
    
    muminjiCount.textContent = `${muminjiSubmitted}/${MUMINJI_STATIONS}`;
    evuroreCount.textContent = `${evuroreSubmitted}/${EVURORE_STATIONS}`;
}

function renderCurrentWard() {
    const wardStations = allStations.filter(s => 
        s.ward && s.ward.toLowerCase() === currentWard
    );
    
    updateStats(wardStations);
    renderCandidatesWithRankings(wardStations);
    renderStationsTable(wardStations);
}

function updateStats(wardStations) {
    const totalRegisteredVoters = currentWard === 'muminji' ? MUMINJI_VOTERS : EVURORE_VOTERS;
    const totalStations = currentWard === 'muminji' ? MUMINJI_STATIONS : EVURORE_STATIONS;
    
    let votesCast = 0;
    let discrepancies = 0;
    
    wardStations.forEach(station => {
        votesCast += station.castedVotes || 0;
        if (station.discrepancyDetected) discrepancies++;
    });
    
    const turnout = totalRegisteredVoters > 0 
        ? ((votesCast / totalRegisteredVoters) * 100).toFixed(1) 
        : 0;
    
    totalRegistered.textContent = totalRegisteredVoters.toLocaleString();
    totalVotesCast.textContent = votesCast.toLocaleString();
    voterTurnout.textContent = `${turnout}% turnout`;
    stationsReported.textContent = wardStations.length;
    stationsTotal.textContent = `/ ${totalStations}`;
    discrepanciesCount.textContent = discrepancies;
    
    const progress = totalStations > 0 
        ? ((wardStations.length / totalStations) * 100).toFixed(1) 
        : 0;
    progressPercent.textContent = `${progress}%`;
    progressFill.style.width = `${progress}%`;
    progressFill.textContent = '';
}

// ========== UPDATED RENDER FUNCTION WITH PROPER PHOTO HANDLING ==========
function renderCandidatesWithRankings(wardStations) {
    const candidates = currentWard === 'muminji' ? MUMINJI_CANDIDATES : EVURORE_CANDIDATES;
    
    // Calculate totals using AGENT votes for faster ranking
    const candidateTotals = {};
    candidates.forEach(c => {
        candidateTotals[c.name] = {
            agent: 0,
            iebc: 0,
            stationsWon: 0,
            party: c.party,
            partyCode: c.partyCode,
            partyColor: c.partyColor,
            initials: c.initials,
            photo: c.photo
        };
    });
    
    // Process each station - use AGENT votes for ranking (faster)
    wardStations.forEach(station => {
        if (station.agentVotes) {
            Object.entries(station.agentVotes).forEach(([candidate, votes]) => {
                if (candidateTotals[candidate]) {
                    candidateTotals[candidate].agent += votes || 0;
                }
            });
        }
        
        if (station.iebcVotes) {
            Object.entries(station.iebcVotes).forEach(([candidate, votes]) => {
                if (candidateTotals[candidate]) {
                    candidateTotals[candidate].iebc += votes || 0;
                }
            });
        }
        
        // Determine winner using AGENT votes
        if (station.agentVotes) {
            let maxVotes = 0;
            let winner = null;
            Object.entries(station.agentVotes).forEach(([candidate, votes]) => {
                if (votes > maxVotes) {
                    maxVotes = votes;
                    winner = candidate;
                }
            });
            if (winner && candidateTotals[winner]) {
                candidateTotals[winner].stationsWon++;
            }
        }
    });
    
    // Calculate differences
    const candidateArray = Object.entries(candidateTotals).map(([name, data]) => ({
        name,
        agent: data.agent,
        iebc: data.iebc,
        diff: data.agent - data.iebc,
        stationsWon: data.stationsWon,
        party: data.party,
        partyCode: data.partyCode,
        partyColor: data.partyColor,
        initials: data.initials,
        photo: data.photo
    }));
    
    // Sort by AGENT votes for ranking
    candidateArray.sort((a, b) => b.agent - a.agent);
    
    const totalAgentVotes = candidateArray.reduce((sum, c) => sum + c.agent, 0);
    
    // Render candidates
    candidatesGrid.innerHTML = '';
    
    candidateArray.forEach((cand, index) => {
        const isWinner = index === 0 && cand.agent > 0;
        const agentPercentage = totalAgentVotes > 0 ? ((cand.agent / totalAgentVotes) * 100).toFixed(1) : 0;
        const iebcPercentage = totalAgentVotes > 0 ? ((cand.iebc / totalAgentVotes) * 100).toFixed(1) : 0;
        
        let diffClass = 'zero';
        if (cand.diff > 0) diffClass = 'positive';
        if (cand.diff < 0) diffClass = 'negative';
        
        const card = document.createElement('div');
        card.className = `candidate-card ${isWinner ? 'winner' : ''}`;
        
        // Create photo URL with fallback to UI Avatars
        const photoUrl = cand.photo || `https://ui-avatars.com/api/?name=${cand.initials}&size=200&background=${cand.partyColor?.replace('#', '') || '0f3b6a'}&color=fff`;
        
        card.innerHTML = `
            ${isWinner ? '<div class="winner-crown"><span>üëë</span> WINNER</div>' : ''}
            <div class="candidate-photo-header" style="background: linear-gradient(135deg, ${cand.partyColor || '#0f3b6a'}, ${cand.partyColor || '#0f3b6a'}dd);">
                <img src="${photoUrl}" alt="${cand.name}" class="candidate-profile-img" onerror="this.src='https://ui-avatars.com/api/?name=${cand.initials}&size=200&background=${cand.partyColor?.replace('#', '') || '0f3b6a'}&color=fff'">
            </div>
            <div class="candidate-info">
                <h3>
                    ${cand.name}
                    <span class="ranking-badge">#${index + 1}</span>
                </h3>
                ${cand.partyCode ? `<div class="candidate-party-badge" style="background: ${cand.partyColor}20; color: ${cand.partyColor};">${cand.partyCode} ¬∑ ${cand.party}</div>` : ''}
            </div>
            <div class="vote-comparison">
                <div class="vote-box agent">
                    <div class="vote-label">AGENT</div>
                    <div class="vote-number">${cand.agent.toLocaleString()}</div>
                    <div class="vote-percentage">${agentPercentage}%</div>
                </div>
                <div class="vote-box iebc">
                    <div class="vote-label">IEBC</div>
                    <div class="vote-number">${cand.iebc.toLocaleString()}</div>
                    <div class="vote-percentage">${iebcPercentage}%</div>
                </div>
                <div class="vote-box diff">
                    <div class="vote-label">DIFF</div>
                    <div class="diff-number ${diffClass}">${cand.diff > 0 ? '+' : ''}${cand.diff.toLocaleString()}</div>
                </div>
            </div>
            <div class="candidate-stats-footer">
                <div class="candidate-stat-item">
                    <span>üèÜ</span>
                    <span>Stations: <strong class="candidate-stat-value">${cand.stationsWon}</strong></span>
                </div>
                <div class="candidate-stat-item">
                    <span>üìä</span>
                    <span>Total: <strong class="candidate-stat-value">${cand.agent.toLocaleString()}</strong></span>
                </div>
            </div>
        `;
        
        candidatesGrid.appendChild(card);
    });
}

function renderStationsTable(wardStations) {
    stationsBody.innerHTML = '';
    
    if (wardStations.length === 0) {
        stationsBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px;">No results reported yet</td></tr>`;
        return;
    }
    
    const sortedStations = [...wardStations].sort((a, b) => 
        a.stationName.localeCompare(b.stationName)
    );
    
    sortedStations.forEach(station => {
        const row = document.createElement('tr');
        const statusClass = station.submittedAt ? 'status-submitted' : 'status-pending';
        const statusText = station.submittedAt ? '‚úì Reported' : '‚è≥ Pending';
        
        row.innerHTML = `
            <td class="station-name">${station.stationName || 'Unknown'}</td>
            <td>${station.formSerialNumber || '‚Äî'}</td>
            <td>${station.registeredVoters?.toLocaleString() || 0}</td>
            <td>${station.castedVotes?.toLocaleString() || 0}</td>
            <td>${station.rejectedVotes?.toLocaleString() || 0}</td>
            <td><span class="station-status ${statusClass}">${statusText}</span></td>
            <td>${station.discrepancyDetected ? '<span class="discrepancy-badge">‚ö†Ô∏è Mismatch</span>' : '‚úì'}</td>
        `;
        
        stationsBody.appendChild(row);
    });
}

// Screenshot function
async function takeScreenshot() {
    try {
        screenshotBtn.disabled = true;
        screenshotBtn.innerHTML = '<span>‚è≥</span> Capturing...';
        
        document.body.classList.add('screenshot-mode');
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const element = document.querySelector('.container');
        const canvas = await html2canvas(element, {
            scale: window.innerWidth < 768 ? 1.5 : 2,
            backgroundColor: '#ffffff',
            logging: false,
            allowTaint: false,
            useCORS: true
        });
        
        document.body.classList.remove('screenshot-mode');
        
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `${currentWard}_results_${new Date().toISOString().slice(0,10)}.png`;
        link.href = image;
        link.click();
        
        notificationMessage.textContent = 'Screenshot saved! üì∏';
        screenshotNotification.style.display = 'flex';
        setTimeout(() => {
            screenshotNotification.style.display = 'none';
        }, 3000);
        
    } catch (error) {
        console.error('Screenshot error:', error);
        document.body.classList.remove('screenshot-mode');
    } finally {
        screenshotBtn.disabled = false;
        screenshotBtn.innerHTML = '<span>üì∏</span> Share';
    }
}

function updateTimestamp() {
    const now = new Date();
    const formatted = now.toLocaleTimeString() + ' ‚Ä¢ ' + now.toLocaleDateString();
    lastUpdatedSpan.textContent = formatted;
    footerTimestamp.textContent = formatted;
}

// Start
initialize();

window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
});
</script>
</body>
</html>
